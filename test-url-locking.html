<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>URL锁定测试 - 对话过程中切换标签页</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #fff5f5;
        }
        .critical-test {
            background: #ffebee;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #f44336;
            border-radius: 8px;
        }
        .test-step {
            background: #e3f2fd;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #2196F3;
            border-radius: 0 5px 5px 0;
        }
        .expected {
            background: #e8f5e8;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #4caf50;
            border-radius: 0 3px 3px 0;
        }
        .warning {
            background: #fff3e0;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ff9800;
            border-radius: 0 3px 3px 0;
        }
        .navigation {
            background: #f3e5f5;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .navigation a {
            display: inline-block;
            margin-right: 15px;
            padding: 8px 15px;
            background: #9c27b0;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-weight: bold;
        }
        .navigation a:hover {
            background: #7b1fa2;
        }
    </style>
</head>
<body>
    <h1>🔒 URL锁定功能测试页面</h1>
    
    <div class="critical-test">
        <h2>🚨 关键测试场景</h2>
        <p><strong>问题描述：</strong>在对话过程中切换Chrome标签页可能导致聊天记录保存到错误的URL。</p>
        <p><strong>解决方案：</strong>在对话开始时锁定URL（currentChatUrl），而不是依赖动态变化的currentUrl。</p>
    </div>
    
    <div class="navigation">
        <h3>测试页面导航</h3>
        <a href="test-chat-history.html">页面A</a>
        <a href="test-chat-history-b.html">页面B</a>
        <a href="test-chat-history-c.html">页面C</a>
        <a href="test-workflow.html">工作流测试</a>
    </div>
    
    <h2>URL锁定机制测试步骤</h2>
    
    <div class="test-step">
        <h3>步骤1：在页面A开始对话</h3>
        <p>1. 在页面A打开Chrome插件侧边栏</p>
        <p>2. 点击"提取原文"按钮</p>
        <p>3. 切换到"对话"标签页</p>
        <p>4. 发送第一条消息："这个页面讲的是什么？"</p>
        <div class="expected">
            <strong>预期结果：</strong>
            <ul>
                <li>currentChatUrl 被设置为页面A的URL</li>
                <li>AI正常回复</li>
                <li>聊天记录保存到页面A的URL</li>
            </ul>
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤2：对话过程中切换标签页（关键测试）</h3>
        <p>1. <strong>在AI回复过程中</strong>，快速切换到其他Chrome标签页</p>
        <p>2. 在其他标签页停留几秒钟</p>
        <p>3. 切换回页面A的标签页</p>
        <p>4. 等待AI回复完成</p>
        <div class="warning">
            <strong>关键测试点：</strong>这一步测试在AI流式回复过程中切换标签页是否会导致URL混乱。
        </div>
        <div class="expected">
            <strong>预期结果：</strong>
            <ul>
                <li>AI回复正常完成</li>
                <li>聊天记录仍然保存到页面A（因为currentChatUrl已锁定）</li>
                <li>不会因为标签页切换而保存到错误的URL</li>
            </ul>
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤3：继续对话测试</h3>
        <p>1. 在页面A发送第二条消息："能详细解释一下吗？"</p>
        <p>2. 再次在AI回复过程中切换到其他标签页</p>
        <p>3. 切换回来等待回复完成</p>
        <div class="expected">
            <strong>预期结果：</strong>
            <ul>
                <li>所有对话都正确保存到页面A</li>
                <li>聊天历史完整且连贯</li>
            </ul>
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤4：切换到页面B验证隔离性</h3>
        <p>1. 导航到页面B</p>
        <p>2. 检查"对话"标签页</p>
        <p>3. 在页面B开始新对话："这里讲的是机器学习吗？"</p>
        <div class="expected">
            <strong>预期结果：</strong>
            <ul>
                <li>页面B显示空白对话或之前的历史（如果有）</li>
                <li>currentChatUrl 更新为页面B的URL</li>
                <li>新对话保存到页面B的URL</li>
            </ul>
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤5：返回页面A验证恢复</h3>
        <p>1. 导航回页面A</p>
        <p>2. 检查"对话"标签页</p>
        <div class="expected">
            <strong>预期结果：</strong>
            <ul>
                <li>完整恢复页面A的聊天历史</li>
                <li>包括之前在标签页切换过程中的所有对话</li>
                <li>聊天记录与页面内容匹配</li>
            </ul>
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤6：极端场景测试</h3>
        <p>1. 在页面A开始一个长对话</p>
        <p>2. 在AI回复的中途：</p>
        <ul>
            <li>新建多个标签页</li>
            <li>在新标签页中访问不同网站</li>
            <li>快速切换多个标签页</li>
            <li>关闭一些标签页</li>
        </ul>
        <p>3. 最后回到页面A等待回复完成</p>
        <div class="expected">
            <strong>预期结果：</strong>
            <ul>
                <li>即使经过复杂的标签页操作，对话仍能正确保存到页面A</li>
                <li>聊天历史不会丢失或错位</li>
            </ul>
        </div>
    </div>
    
    <h2>技术验证点</h2>
    
    <div class="critical-test">
        <h3>🔧 代码层面的改进</h3>
        <ul>
            <li><strong>新增变量：</strong>currentChatUrl - 在对话开始时锁定URL</li>
            <li><strong>锁定时机：</strong>在restoreChatHistoryForUrl()中设置currentChatUrl</li>
            <li><strong>保存机制：</strong>sendChatMessage()和callChatAPI()使用currentChatUrl而不是currentUrl</li>
            <li><strong>防止混乱：</strong>即使currentUrl因标签页切换而改变，currentChatUrl保持不变</li>
        </ul>
    </div>
    
    <h2>本页面测试内容</h2>
    
    <div class="test-step">
        <h3>URL锁定机制专题</h3>
        <p>这个页面专门用于测试URL锁定功能，确保在复杂的标签页切换场景下聊天历史能够正确保存和恢复。</p>
        
        <h4>测试重点</h4>
        <ul>
            <li>对话过程中的标签页切换</li>
            <li>AI流式回复期间的URL稳定性</li>
            <li>多标签页并发操作</li>
            <li>极端场景下的数据完整性</li>
        </ul>
        
        <h4>验证标准</h4>
        <ul>
            <li>✅ 聊天记录始终保存到正确的URL</li>
            <li>✅ 标签页切换不影响当前对话会话</li>
            <li>✅ 每个页面的聊天历史独立且完整</li>
            <li>✅ 复杂操作后数据不丢失不错位</li>
        </ul>
    </div>
    
    <div class="warning">
        <h3>⚠️ 注意事项</h3>
        <p>这个测试特别重要，因为它模拟了真实用户使用场景中最容易出现问题的情况。用户在等待AI回复时很可能会切换到其他标签页查看其他内容，然后再回来查看回复。如果URL锁定机制不正确，就会导致聊天记录保存到错误的页面。</p>
    </div>
</body>
</html>