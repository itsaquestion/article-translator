<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时检查测试 - URL监控机制</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background-color: #f9f9f9;
        }
        .polling-test {
            background: #e8f5e8;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #4caf50;
            border-radius: 8px;
        }
        .test-step {
            background: #fff3e0;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
            border-radius: 0 5px 5px 0;
        }
        .expected {
            background: #e3f2fd;
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #2196f3;
            border-radius: 0 3px 3px 0;
        }
        .technical {
            background: #f3e5f5;
            padding: 15px;
            margin: 15px 0;
            border: 1px solid #9c27b0;
            border-radius: 5px;
        }
        .navigation {
            background: #ffebee;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .navigation a {
            display: inline-block;
            margin-right: 15px;
            padding: 8px 15px;
            background: #f44336;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-weight: bold;
        }
        .navigation a:hover {
            background: #d32f2f;
        }
        .counter {
            background: #e1f5fe;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>⏱️ 定时检查机制测试页面</h1>
    
    <div class="polling-test">
        <h2>🔄 URL监控机制</h2>
        <p><strong>新方案：</strong>使用定时检查（每秒1次）来监测当前标签页URL变化，替代复杂的消息传递机制。</p>
        <p><strong>优势：</strong>简单可靠，不依赖background script和side panel之间的消息传递。</p>
    </div>
    
    <div class="navigation">
        <h3>测试页面导航</h3>
        <a href="test-chat-history.html">页面A (AI发展)</a>
        <a href="test-chat-history-b.html">页面B (机器学习)</a>
        <a href="test-chat-history-c.html">页面C (深度学习)</a>
        <a href="test-auto-switch.html">自动切换测试</a>
    </div>
    
    <div class="counter">
        <p>页面加载时间: <span id="loadTime"></span></p>
        <p>当前时间: <span id="currentTime"></span></p>
        <p>页面停留时长: <span id="stayDuration"></span></p>
    </div>
    
    <h2>定时检查机制测试步骤</h2>
    
    <div class="test-step">
        <h3>步骤1：准备测试环境</h3>
        <p>1. 打开Chrome插件侧边栏</p>
        <p>2. 在当前页面建立一些聊天历史</p>
        <p>3. 观察插件的行为</p>
        <div class="expected">
            <strong>预期：</strong>定时检查机制每秒运行一次，监测URL变化
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤2：快速页面切换测试</h3>
        <p>1. 快速点击不同的导航链接</p>
        <p>2. 观察"对话"tab是否能及时更新</p>
        <p>3. 测试多次快速切换</p>
        <div class="expected">
            <strong>预期：</strong>在1秒内检测到URL变化并自动更新聊天历史
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤3：标签页切换测试</h3>
        <p>1. 新建标签页，访问不同的测试页面</p>
        <p>2. 在不同标签页间切换</p>
        <p>3. 观察每次切换后的反应时间</p>
        <div class="expected">
            <strong>预期：</strong>切换标签页后最多1秒内自动更新
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤4：地址栏直接输入测试</h3>
        <p>1. 在地址栏直接输入新的URL</p>
        <p>2. 按回车导航到新页面</p>
        <p>3. 观察插件的响应</p>
        <div class="expected">
            <strong>预期：</strong>URL变化后自动检测并更新聊天历史
        </div>
    </div>
    
    <div class="test-step">
        <h3>步骤5：性能测试</h3>
        <p>1. 长时间保持插件开启</p>
        <p>2. 观察是否有性能问题</p>
        <p>3. 检查内存使用情况</p>
        <div class="expected">
            <strong>预期：</strong>定时检查不会造成明显的性能负担
        </div>
    </div>
    
    <div class="technical">
        <h3>🔧 技术实现详情</h3>
        
        <h4>定时检查函数</h4>
        <pre style="background: #f5f5f5; padding: 10px; border-radius: 3px; font-size: 12px;">
function startUrlMonitoring() {
    setInterval(() => {
        chrome.tabs.query({ active: true, currentWindow: true }, (tabs) => {
            if (tabs[0] && tabs[0].url !== currentUrl) {
                // URL发生变化，触发内容更新
                handleTabChange();
            }
        });
    }, 1000); // 每秒检查一次
}
        </pre>
        
        <h4>启动时机</h4>
        <ul>
            <li>在DOM加载完成后启动：<code>startUrlMonitoring()</code></li>
            <li>侧边栏可见性变化时额外检查</li>
        </ul>
        
        <h4>检查频率</h4>
        <ul>
            <li>每1000ms检查一次（1秒）</li>
            <li>平衡了响应性和性能</li>
            <li>对于用户操作来说1秒延迟是可接受的</li>
        </ul>
    </div>
    
    <h2>本页面测试内容</h2>
    
    <div class="test-step">
        <h3>定时检查机制专题</h3>
        <p>这个页面专门用于测试新的定时检查机制，确保URL监控功能正常工作。</p>
        
        <h4>测试重点</h4>
        <ul>
            <li>URL变化检测的及时性</li>
            <li>不同导航方式的兼容性</li>
            <li>性能影响评估</li>
            <li>稳定性验证</li>
        </ul>
        
        <h4>成功标准</h4>
        <ul>
            <li>✅ URL变化在1秒内被检测到</li>
            <li>✅ 聊天历史自动切换正常</li>
            <li>✅ 不会造成性能问题</li>
            <li>✅ 长时间运行稳定</li>
        </ul>
        
        <p>通过定时检查机制，我们避免了复杂的消息传递，确保URL变化能被可靠检测到。</p>
    </div>
    
    <script>
        // 显示页面加载和停留时间
        const loadTime = new Date();
        document.getElementById('loadTime').textContent = loadTime.toLocaleTimeString();
        
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
            
            const duration = Math.floor((now - loadTime) / 1000);
            document.getElementById('stayDuration').textContent = duration + ' 秒';
        }
        
        setInterval(updateTime, 1000);
        updateTime();
    </script>
</body>
</html>